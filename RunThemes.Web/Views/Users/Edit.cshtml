@using NearForums
@using NearForums.Web.Extensions
@model RunThemes.Data.Models.User
@{
    ViewBag.Title = string.Format("Account");
}
<ul class="path floatContainer">
    <li class="first">@Html.ActionLinkLocalized("Forums", "List", "Forums")</li>
</ul>
<h1>@ViewBag.Title</h1>
@Html.ValidationSummary("<h3>" + string.Format("Please check the following errors:") + "</h3>", new Dictionary<string, object>
	{
		{"Email", string.Format("Email format is invalid.")}
		,{"Website", string.Format("Website url format is invalid.")}
		,{"Photo", string.Format("Photo url format is invalid.")}
		,{"Username", string.Format("Username is required.")}
	})
@{Html.BeginForm(null, null, FormMethod.Post, new { @id = "accountForm" });}
@Html.Hidden("gravatarPhoto")
<fieldset>
    <legend>@string.Format("Change your account information")</legend>
    <div class="formItem floatContainer">
		<label for="title">@string.Format("Public name")</label>
		@Html.TextBox("userName", null, new { @class = "text" })
    </div>
    <div class="formItem floatContainer">
		<label for="birthDate">@string.Format("Birthdate")</label>
        @Html.TextBox("birthDate", this.Model.BirthDate != null ? this.Model.BirthDate.ToString("d") : null, new { @class = "text" })
	</div>
	<div class="formItem floatContainer" style="display: none;">
		<label for="timezone">@string.Format("Timezone")</label>
        @Html.TextBox("timezone", null, new { @class = "text" })
    </div>
    <div class="formItem floatContainer">
		<label>@string.Format("Profile image")</label>
		<div class="photo" id="photoPreview"></div>
		<select onchange="return changePhoto(this);">
			<option>@string.Format("Change photo")</option>
			<option value="gravatar">@string.Format("Use gravatar image")</option>
			<option value="remove">@string.Format("Remove photo")</option>
		</select>
	</div>
	<div class="formItem floatContainer" style="display:none;">
		<label for="photo">@string.Format("Photo url")</label>
		@Html.TextBox("photo", null, new { @class = "text" })
    </div>
	<div class="formItem floatContainer">
		<label for="website">@string.Format("Website")</label>
        @Html.TextBox("website", null, new { @class = "text" })
	</div>
	<p class="button"><input type="button" class="button" value="@string.Format("Change Password")" onclick="window.location.href='@Url.Action("ChangePassword", "FormsAuthentication", new { returnUrl = this.Request.Url.PathAndQuery })';" /></p>
</fieldset>

	<h2>@string.Format("Email")</h2>
	<fieldset>
		<legend>@string.Format("Your email will not be shared with anyone. We will not make a different use than detailed below.")</legend>
		<div class="formItem floatContainer">
			<label for="email">@string.Format("Email address")</label>
			@Html.TextBox("email", null, new { @class = "text" })
		</div>
		<div class="formItem floatContainer">
			<div class="checkbox" style="padding-top: 10px;">
				@(Html.CheckBoxBit<EmailPolicy>("policy1", this.Model.EmailPolicy, EmailPolicy.SendFromSubscriptions))
				<label for="policy1">@string.Format("Use my email to notify me of replies to threads I subscribed to")</label>
			</div>
			<div class="checkbox" style="padding-top: 10px;">
				@(Html.CheckBoxBit<EmailPolicy>("policy2", this.Model.EmailPolicy, EmailPolicy.SendNewsletter))
				<label for="policy3">@string.Format("Send me a newsletter")</label>
				@Html.Hidden("emailPolicy")
			</div>
		</div>
	</fieldset>

<div class="formItem buttons">
	<input type="submit" value="@string.Format("Submit")" />
</div>
@{Html.EndForm();}
<p class="action"><a href="/account/edit">@string.Format("To edit your account settings, click here")</a></p>
<script type="text/javascript">
    $(document).ready(function () {
        $("#accountForm").submit(function () {
            calculateEmailPolicy();
        });
		showPhotoPreview();
    });

    function calculateEmailPolicy() {
        var value = 0;
        $("input:checked", $("#emailPolicy").parents("div.formItem")).each(function () {
            value += parseInt($(this).val(), 10);
        });
        $("#emailPolicy").val(value);
    }

	function showPhotoPreview()
	{
		var photoUrl = $.trim($("#photo").val());
		var img = $("#photoPreview img");
		if (photoUrl != "")
		{
			if (img.length == 0)
			{
				img = $("<img />").appendTo($("#photoPreview"));
			}
			img.prop("src", photoUrl);
		}
		else
		{
			img.remove();
		}
	}

	function changePhoto(sender)
	{
		var value = $(sender).val();
		sender.selectedIndex = 0;
		switch (value)
		{
			case "gravatar":
				assignGravatar();
				break;
			case "remove":
				$("#photo").val("");
				break;
		}
		showPhotoPreview();
		return false;
	}

	function assignGravatar()
	{
		var gravatarPhoto = $("#gravatarPhoto").val();
		if (gravatarPhoto == "")
		{
			alert("You must specify an email address to use Gravatar.");
			return;
		}
		$("#photo").val(gravatarPhoto);
	}
</script>
